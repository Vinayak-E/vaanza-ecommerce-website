
<%- include('../layout/header.ejs') -%>

<style>
.custom-close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1060; /* Ensure it's above the modal backdrop */
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    color: #000; /* Adjust color as needed */
}

.custom-close-btn:hover {
    color: #555; /* Hover color */
}

.custom-close-btn:focus {
    outline: none; /* Remove default focus outline */
}


    .modal-xl {
        max-width: 60%;
    }
    .modal-body .form-control {
        margin-bottom: 1rem;
    }
    .modal-body {
        padding: 2rem;
    }

    .error-message {
        color: red;
        font-size: 0.875em;
        margin-top: 5px;
    }

    .order-product-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
    }

    .variant-image {
        width: 100px;
        height: 150px;
        object-fit: cover;
        margin-right: 10px;
    }

    .order-product-details {
        flex-grow: 1;
    }

    .order-product-status {
        margin-left: 20px;
        text-align: right;
    }

    .order-product-details p, .order-product-status p {
        margin: 0;
    }

    .order-summary {
    background-color: #ffffff;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 30px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    border: 1px solid #e0e0e0;
}

.order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 15px;
}

.order-id {
    font-size: 1.4rem;
    color: #333333;
    margin: 0;
    font-weight: 600;
}

.order-date {
    font-size: 1rem;
    color: #666666;
}

.details-right {
    text-align: right;
}

.btn-invoice {
    margin-top: 10px;
}

.order-details {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    margin-top: 20px;
}

.order-info {
    flex: 1;
    min-width: 200px;
    margin-right: 30px;
}

.info-item {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.info-item i {
    margin-right: 12px;
    color: #007bff;
    font-size: 1.2rem;
}

.shipping-info {
    flex: 2;
    min-width: 300px;
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
}

.shipping-info h6 {
    color: #333333;
    margin-bottom: 12px;
    font-weight: 600;
}

.shipping-info p {
    margin-bottom: 8px;
    color: #555555;
}

.retry-payment-section {
    margin-top: 25px;
    text-align: center;
    background-color: #fff3cd;
    border: 1px solid #ffeeba;
    border-radius: 8px;
    padding: 15px;
}

.retry-payment {
    margin-top: 12px;
}

.view-order-details {
    display: inline-block;
    margin-top: 20px;
    color: #007bff;
    text-decoration: none;
    font-weight: 600;
}

@media (max-width: 768px) {
    .order-details {
        flex-direction: column;
    }
    
    .order-info, .shipping-info {
        width: 100%;
        margin-right: 0;
        margin-bottom: 20px;
    }
    
    .order-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .details-right {
        text-align: left;
        margin-top: 10px;
    }
}



    .input-group-append .btn {
        padding: 0.375rem 0.75rem;
        font-size: 14px;
        line-height: 0.5;
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
    }

    .icon-copy {
        font-size: 12px;
        margin-right: 5px;
    }

   
</style>

</head>

<body>
    <div class="page-wrapper">
        <header class="header">
            <div class="header-top">
            </div><!-- End .header-top -->

            <div class="header-middle sticky-header">
                <div class="container">
                    <div class="header-left">
                      
                        <button class="mobile-menu-toggler">
                            <span class="sr-only">Toggle mobile menu</span>
                            <i class="icon-bars" style="color: black;"></i>
                        </button>

                        <a href="/" class="logo">
                            <img src="/assets/images/logo.png" alt="Molla Logo" width="105" height="25">
                        </a>

                        <nav class="main-nav">
                            <ul class="menu ">
                                <li>
                                    <a href="/shop/gender/Men" class="">MEN</a>
                                </li>
                                <li>
                                    <a href="/shop/gender/Women" class="">WOMEN</a>
                                </li>
                                <li>
                                    <a href="/about">ABOUT US</a>
                                </li>
                                <li>
                                    <a href="/contact">CONTACT</a>
                                </li>
                            </ul><!-- End .menu -->
                        </nav><!-- End .main-nav -->
                    </div><!-- End .header-left -->

                    <div class="header-right">
                          <a href="/wishlist" class="wishlist-link">
                            <i class="icon-heart-o"></i>
                        </a>

                          <div class="dropdown cart-dropdown">
                            <a href="/cart" class="dropdown-toggle" aria-haspopup="true" aria-expanded="false" >
                                <i class="icon-shopping-cart"></i>
                                <span class="cart-count"><%= cartCount %></span>
                            </a>
                        </div><!-- End .cart-dropdown -->
                    </div><!-- End .header-right -->
                </div><!-- End .container -->
            </div><!-- End .header-middle -->
        </header><!-- End .header -->

        <main class="main">
        	<div class="page-header text-center" style="background-image: url('assets/images/page-header-bg.jpg')">
        		<div class="container">
        			<h1 class="page-title">My Account<span>VAANZA</span></h1>
        		</div><!-- End .container -->
        	</div><!-- End .page-header -->
            <nav aria-label="breadcrumb" class="breadcrumb-nav mb-3">
                <div class="container">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <!-- <li class="breadcrumb-item"><a href="#">Shop</a></li> -->
                        <li class="breadcrumb-item active" aria-current="page">My Account</li>
                    </ol>
                </div><!-- End .container -->
            </nav><!-- End .breadcrumb-nav -->

            <div class="page-content">
            	<div class="dashboard">
	                <div class="container">
	                	<div class="row">
	                		<aside class="col-md-4 col-lg-3">
                                <ul class="nav nav-dashboard flex-column mb-3 mb-md-0" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" id="tab-dashboard-link" data-toggle="tab" href="#tab-dashboard" role="tab" aria-controls="tab-dashboard" aria-selected="true">My Profile</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="tab-orders-link" data-toggle="tab" href="#tab-orders" role="tab" aria-controls="tab-orders" aria-selected="false">Orders</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="tab-wallet-link" data-toggle="tab" href="#tab-wallet" role="tab" aria-controls="tab-wallet" aria-selected="false">Wallet</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="tab-address-link" data-toggle="tab" href="#tab-address" role="tab" aria-controls="tab-address" aria-selected="false">Address</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="/logout">Sign Out</a>
                                    </li>
                                </ul>
                            </aside>
                          
   
	                		<div class="col-md-8 col-lg-9">
	                			<div class="tab-content">
								    <div class="tab-pane fade show active" id="tab-dashboard" role="tabpanel" aria-labelledby="tab-dashboard-link">
                                        <form id="profile-form" onsubmit="return validate()">
                                            <div class="row">
                                                <div class="col-sm-6">
                                                    <label>Name *</label>
                                                    <input type="text" id="profile-name" name="name" value="<%= locals.user.name %>" class="form-control" required readonly>
                                                    <div id="name-error" class="error-message"></div>
                                                </div><!-- End .col-sm-6 -->
                                            </div><!-- End .row -->
                                            <div class="col-sm-6">
                                            <label>Email address *</label>
                                            <input type="email" id="profile-email" name="email" value="<%= locals.user.email %>" class="form-control" required readonly>
                                            <div id="email-error" class="error-message"></div>
                                        </div><!-- End .col-sm-6 -->
                                        <div class="col-sm-6">
                                            <label>Mobile Number</label>
                                            <input type="text" id="profile-phone" name="mobile" value="<%= locals.user.mobile %>" class="form-control" readonly>
                                            <div id="mobile-error" class="error-message"></div>
                                        </div><!-- End .col-sm-6 -->
                                        <div class="col-sm-6">
                                            <label>Your Referral Code</label>
                                            <div class="input-group">
                                                <input type="text" id="referral-code" value="<%= locals.user.referralCode %>" class="form-control" readonly>
                                                <div class="input-group-append">
                                                    <button class="btn btn-link" type="button" onclick="copyReferralCode()">
                                                        <i class="icon-copy"></i> Copy
                                                    </button>
                                                </div>
                                            </div>
                                        </div><!-- End .col-sm-6 -->
                                        <div class="col-sm-6">
                                            <button type="button" id="editButton" class="btn btn-outline-primary-2" onclick="toggleEdit()">
                                                <span>EDIT</span>
                                                <i class="icon-long-arrow-right"></i>
                                            </button>
                                            <button type="submit" id="updateButton" class="btn btn-outline-primary-2" style="display:none;">
                                                <span>UPDATE</span>
                                                <i class="icon-long-arrow-right"></i>
                                            </button>
                                      
                                            <button type="button" class="btn btn-outline-primary-2 m-5" data-toggle="modal" data-target="#exampleModal">
                                                <span>Change Password</span>
                                                <i class="icon-long-arrow-right"></i>
                                            </button>
                                        </div>
                                        </form>
                                        </div><!-- .End .tab-pane -->
 
								   

                                        <div class="tab-pane fade" id="tab-orders" role="tabpanel" aria-labelledby="tab-orders-link">
                                            <% if (orders && orders.length > 0) { %>
                                                <div class="order-list">
                                                    <% orders.forEach(order => { %>
                                                        <div class="order-item">
                                                            <div class="order-header">
                                                                <div class="order-summary">
                                                                    <div class="order-header">
                                                                        <h5 class="order-id">Order #<%= order.orderId %></h5>
                                                                        <span class="order-date"><%= new Date(order.orderDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %></span>
                                                                    </div>
                                                                    <div class="details-right text-right">
                                                                        <% if (order.products.some(product => product.status === 'Delivered' || product.status === 'Return Requested'|| product.status === 'Returned')) { %>
                                                                            <button class="btn btn-primary btn-invoice" data-order-id="<%= order.orderId %>">Download Invoice</button>
                                                                        <% } %>
                                                                    </div>
                                                                    <div class="order-details">
                                                                        <div class="order-info">
                                                                            <div class="info-item">
                                                                                <i class="fas fa-money-bill-wave"></i>
                                                                                <span>₹<%= order.totalAmount.toFixed(2) %></span>
                                                                            </div>
                                                                            <div class="info-item">
                                                                                <i class="fas fa-credit-card"></i>
                                                                                <span><%= order.paymentMethod %></span>
                                                                            </div>
                                                                            <div class="info-item">
                                                                                <i class="fas fa-credit-card"></i>
                                                                                <span><%= order.paymentStatus %></span>
                                                                            </div>
                                                                        </div>
                                                                        
                                                                        <div class="shipping-info">
                                                                            <h6><i class="fas fa-shipping-fast"></i> Shipping Details</h6>
                                                                            <p><strong><%= order.address.name %></strong></p>
                                                                            <p><%= order.address.address %>, <%= order.address.street %></p>
                                                                            <p><%= order.address.state %>, <%= order.address.postalCode %></p>
                                                                            <p><i class="fas fa-phone"></i> <%= order.address.number %></p>
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    <% if (order.paymentStatus === 'Failed' && order.paymentMethod === 'Razor pay') { %>
                                                                        <div class="retry-payment-section">
                                                                            <p class="alert alert-warning">Payment failed. You can retry the payment to complete your order.</p>
                                                                            <button type="button" class="btn btn-primary retry-payment" onclick="retryPayment('<%= order._id %>', <%= order.totalAmount %>)">
                                                                                <i class="fas fa-redo"></i> Retry Payment
                                                                            </button>
                                                                        </div>
                                                                    <% } %>
                                  
                                                                <div>
                                                                    <a href="javascript:void(0);" class="view-order-details" onclick="toggleOrderDetails('<%= order._id %>')"><strong>View Order Details</strong></a>
                                                                </div>
                                                            </div>
                                                        </div>
                                                            <div class="order-products" id="order-products-<%= order._id %>" style="display: none;">
                                                                <h6>Products:</h6>
                                                                <ul>
                                                                    <% order.products.forEach(item => { %>
                                                                        <li>
                                                                            <div class="order-product-item">
                                                                                <% 
                                                                                    const product = item.productId;
                                                                                    const variant = product.variants.find(v => v.sizes.includes(item.size));
                                                                                    const variantImage = variant ? variant.images[0] : '';
                                                                                %>
                                                                                <div class="order-product-image">
                                                                                    <img src="/assets/images/productImage/<%= variantImage %>" alt="<%= product.name %>" class="variant-image">
                                                                                </div>
                                                                                <div class="order-product-details">
                                                                                    <p class="mb-1"><strong>Product Name:</strong> <%= product.name %></p>
                                                                                    <p class="mb-1"><strong>Size:</strong> <%= item.size %></p>
                                                                                    <p class="mb-1"><strong>Quantity:</strong> <%= item.quantity %></p>
                                                                                    <p class="mb-1"><strong>Price:</strong> ₹<%= item.price.toFixed(2) %></p>   
                                                                                    <% if (item.status === 'Cancelled') { %>
                                                                                        <button type="button" class="btn btn-outline-danger mb-1" disabled>Cancelled</button>
                                                                                      <% } else if (item.status === 'Delivered') { %>
                                                                                        <button type="button" class="btn btn-outline-warning mb-1" onclick="openReturnModal('<%= order._id %>', '<%= product._id %>', '<%= variant._id %>')">Return Request</button>
                                                                                        <% } else if ((item.status === 'Pending' || item.status === 'Out for Delivery' || item.status === 'Dispatched') && order.paymentStatus !== "Failed") { %>
                                                                                            <button type="button" class="btn btn-outline-danger mb-1" onclick="openCancelModal('<%= order._id %>', '<%= product._id %>', '<%= variant._id %>')">Cancel</button>
                                                                                          <% } %>
                                                                                          
                                                                                </div>
                                                                                

                                                                                   
                                                                              
                                                                                <div class="order-product-status">
                                                                                    <span class="badge 
                                                                                    <% if (item.status === 'Pending') { %>bg-warning text-dark<% } else if (item.status === 'Dispatched') { %>bg-info<% } else if (item.status === 'Out For Delivery') { %>bg-primary<% } else if (item.status === 'Delivered') { %>bg-success text-white<% } %>">
                                                                                    <%= item.status %>
                                                                                  </span>
                                                                                </div>
                                                                            </div>
                                                                        </li>
                                                                    <% }) %>
                                                                </ul>
                                                               
                                                            </div>
                                                           
                                                        </div>
                                                        <hr>
                                                    <% }) %>
                                                </div>
                                            <% } else { %>
                                                <p>No order has been made yet.</p>
                                            <% } %>
                                        </div><!-- .End .tab-pane -->
                                        
                                     
                                        
                                        <!-- Cancel Order Modal -->
<!-- Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cancelModalLabel">Cancel Product</h5>
          <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="cancelOrderId">
          <input type="hidden" id="cancelProductId">
          <input type="hidden" id="cancelVariantId">
          <div class="mb-3">
            <label for="cancelReason" class="form-label">Reason for Cancellation</label>
            <textarea class="form-control" id="cancelReason" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-danger" id="confirmCancelButton">Cancel Product</button>
        </div>
      </div>
    </div>
  </div>
  
<!-- modal End   -->

<!-- Return Modal -->
<div class="modal fade" id="returnModal" tabindex="-1" aria-labelledby="returnModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="returnModalLabel">Return Request</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="returnOrderId">
          <input type="hidden" id="returnProductId">
          <input type="hidden" id="returnVariantId">
          <div class="mb-3">
            <label for="returnReason" class="form-label">Reason for Return</label>
            <textarea class="form-control" id="returnReason" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-warning" id="confirmReturnButton">Submit</button>
        </div>
      </div>
    </div>
  </div>
  




  <div class="tab-pane fade" id="tab-wallet" role="tabpanel" aria-labelledby="tab-wallet-link">
    <div class="card card-dashboard shadow">
        <div class="row g-0">
            <div class="col-12">
                <div class="card-body d-flex align-items-center justify-content-center py-4 mb-3" style="background-image: url(/assets/images/banners/Wallet\ Banner.png.webp); background-size: cover; background-position: center;">
                    <h3 class="text-light ls-3 mb-0">Vaanza Wallet</h3>
                </div>
            </div>
        </div>
        <div class="row g-0">
            <div class="col-12 col-md-6 offset-md-3 col-lg-6 offset-lg-0">
                <div class="card-body p-4">
                    <h5 class="text-muted mb-3">Balance Amount: <span class="text-dark"><%= wallet ? wallet.balance.toFixed(2) : '0.00' %></span></h5>
                    <div class="d-flex flex-column gap-3">
                        <a href="#" class="d-flex align-items-center text-muted" data-toggle="modal" data-target="#transactionDetailsModal">
                            <i class="fa-solid fa-clock-rotate-left fa-la mr-2" style="color: #cc9966;"></i>
                            Transaction history
                        </a>
                        <button class="btn btn-outline-primary" id="showRecentTransactions">Show Recent Transactions</button>
                    </div>
                    <div class="transaction-list mt-4" id="recentTransactions" style="display: none;">
                        <h5 class="mb-3">Recent Transactions:</h5>
                        <% if (wallet && wallet.transactions.length > 0) { %>
                            <ul class="list-group">
                                <% wallet.transactions.forEach(transaction => { %>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>
                                            <strong><%= transaction.type === 'credit' ? '+' : '-' %>₹<%= transaction.amount.toFixed(2) %></strong>
                                            <br>
                                            <small class="text-muted">Transaction ID: <%= transaction.transactionId %></small> 
                                            <br>
                                            <small class="text-muted"><%= transaction.productName %></small><br>
                                            <small class="text-muted"><%= new Date(transaction.timestamp).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %> at <%= new Date(transaction.timestamp).toLocaleTimeString('en-US') %></small>
                                        </span>
                                        <span class="badge <%= transaction.type === 'credit' ? 'badge-success' : 'badge-danger' %> badge-pill"><%= transaction.type %></span>
                                    </li>
                                <% }) %>
                            </ul>
                        <% } else { %>
                            <p>No transactions found.</p>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




                                    <div class="tab-pane fade" id="tab-address" role="tabpanel" aria-labelledby="tab-address-link">
                                        <button type="button" class="btn btn-outline-primary-2 mb-1 mx-4" data-toggle="modal" data-target="#addAddressModal">
                                            <span>Add Address</span>
                                            <i class="icon-long-arrow-right"></i>
                                        </button>
                                    
                                        <div id="address-container">
                                            <% if (addresses && addresses.length > 0) { %>
                                                <% addresses.forEach((address, index) => { %>
                                                    <div class="col-lg-12 address-card"  data-address-id="<%= address._id %>">
                                                        <div class="card card-dashboard">
                                                            <div class="card-body">
                                                                <h3 class="card-title"> Address</h3>
                                                                <p>
                                                                    <%= address.name %><br>
                                                                    <%= address.address %><br>
                                                                    <%= address.street %><br>
                                                                    <%= address.state %>, <%= address.postalCode %><br>
                                                                    <%= address.landmark %><br>
                                                                    <%= address.number %><br>
                                                                    <button type="button" class="btn btn-outline-primary edit-address" data-index="<%= index %>" data-toggle="modal" data-target="#editAddressModal">Edit <i class="icon-edit"></i></button>
                                                                    <button type="button" class="btn btn-outline-danger delete-address mx-4" data-address-id="<%= address._id %>">Delete</button>
                                                                </p>
                                                            </div><!-- End .card-body -->
                                                        </div><!-- End .card-dashboard -->
                                                    </div><!-- End .col-lg-6 -->
                                                <% }) %>
                                            <% } else { %>
                                                <p>No addresses found.</p>
                                            <% } %>
                                        </div>
                                    </div>
                            
                                                <!-- Add Address Modal -->
                            <div class="modal fade" id="addAddressModal" tabindex="-1" role="dialog" aria-labelledby="addAddressModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title text-center w-100" id="addAddressModalLabel">Add Address</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <form id="address-form" onsubmit="return validateAddressForm()">
                                                <div class="row">
                                                    <div class="col-sm-6">
                                                        <label for="name">Full Name *</label>
                                                        <input type="text" class="form-control" id="name" name="name" required>
                                                        <div class="error-message" id="name-error"></div>
                                                    </div><!-- End .col-sm-6 -->
                            
                                                    <div class="col-sm-6">
                                                        <label for="number">Mobile Number *</label>
                                                        <input type="text" class="form-control" id="number" name="number" required>
                                                        <div class="error-message" id="number-error"></div>
                                                    </div><!-- End .col-sm-6 -->
                                                </div><!-- End .row -->
                            
                                                <label for="address">Address *</label>
                                                <input type="text" class="form-control" id="address" name="address" required>
                                                <div class="error-message" id="address-error"></div>
                            
                                                <div class="row">
                                                    <div class="col-sm-6">
                                                        <label for="street">Street/City *</label>
                                                        <input type="text" class="form-control" id="street" name="street" required>
                                                        <div class="error-message" id="street-error"></div>
                                                    </div><!-- End .col-sm-6 -->
                            
                                                    <div class="col-sm-6">
                                                        <label for="postalCode">Pincode *</label>
                                                        <input type="text" class="form-control" id="postalCode" name="postalCode" required>
                                                        <div class="error-message" id="postalCode-error"></div>
                                                    </div><!-- End .col-sm-6 -->
                                                </div><!-- End .row -->
                            
                                                <div class="row">
                                                    <div class="col-sm-6">
                                                        <label for="state">State *</label>
                                                        <select class="form-control" id="state" name="state" required>
                                                            <option value="" disabled selected>Select your state</option>
                                                            <option value="Kerala">Kerala</option>
                                                            <option value="Tamil Nadu">Tamil Nadu</option>
                                                            <option value="Karnataka">Karnataka</option>
                                                            <!-- Add more options as needed -->
                                                        </select>
                                                        <div class="error-message" id="state-error"></div>
                                                    </div><!-- End .col-sm-6 -->
                            
                                                    <div class="col-sm-6">
                                                        <label for="landmark">Landmark</label>
                                                        <input type="text" class="form-control" id="landmark" name="landmark">
                                                        <div class="error-message" id="landmark-error"></div>
                                                    </div><!-- End .col-sm-6 -->
                                                </div><!-- End .row -->
                            
                                                <input type="hidden" id="userId" value="<%= user._id %>">
                                                <div class="text-center mt-3">
                                                    <button type="submit" class="btn btn-outline-primary-2">
                                                        <span>SAVE CHANGES</span>
                                                        <i class="icon-long-arrow-right"></i>
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        <!-----Add Address modal End------>


                                        <!-- Edit Address Modal -->
                                        <div class="modal fade" id="editAddressModal" tabindex="-1" role="dialog" aria-labelledby="editAddressModalLabel" aria-hidden="true">
                                            <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title text-center w-100" id="editAddressModalLabel">Edit Address</h5>
                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                            <span aria-hidden="true">&times;</span>
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <form id="Editaddress-form">
                                                            <input type="hidden" id="EditId" name="id">
                                                            <div class="row">
                                                                <div class="col-sm-6">
                                                                    <label for="Editname">Full Name *</label>
                                                                    <input type="text" class="form-control" id="Editname" name="name" required>
                                                                    <div class="error-message" id="Editname-error"></div>
                                                                </div><!-- End .col-sm-6 -->
                                        
                                                                <div class="col-sm-6">
                                                                    <label for="Editnumber">Mobile Number *</label>
                                                                    <input type="text" class="form-control" id="Editnumber" name="number" required>
                                                                    <div class="error-message" id="Editnumber-error"></div>
                                                                </div><!-- End .col-sm-6 -->
                                                            </div><!-- End .row -->
                                        
                                                            <label for="Editaddress">Address *</label>
                                                            <input type="text" class="form-control" id="Editaddress" name="address" required>
                                                            <div class="error-message" id="Editaddress-error"></div>
                                        
                                                            <div class="row">
                                                                <div class="col-sm-6">
                                                                    <label for="Editstreet">Street/City *</label>
                                                                    <input type="text" class="form-control" id="Editstreet" name="street" required>
                                                                    <div class="error-message" id="Editstreet-error"></div>
                                                                </div><!-- End .col-sm-6 -->
                                        
                                                                <div class="col-sm-6">
                                                                    <label for="EditpostalCode">Pincode *</label>
                                                                    <input type="text" class="form-control" id="EditpostalCode" name="postalCode" required>
                                                                    <div class="error-message" id="EditpostalCode-error"></div>
                                                                </div><!-- End .col-sm-6 -->
                                                            </div><!-- End .row -->
                                        
                                                            <div class="row">
                                                                <div class="col-sm-6">
                                                                    <label for="Editstate">State *</label>
                                                                    <select class="form-control" id="Editstate" name="state" required>
                                                                        <option value="" disabled selected>Select your state</option>
                                                                        <option value="Kerala">Kerala</option>
                                                                        <option value="Tamil Nadu">Tamil Nadu</option>
                                                                        <option value="Karnataka">Karnataka</option>
                                                                        <!-- Add more options as needed -->
                                                                    </select>
                                                                
                                                                    <div class="error-message" id="Editstate-error"></div>
                                                                </div><!-- End .col-sm-6 -->
                                        
                                                                <div class="col-sm-6">
                                                                    <label for="Editlandmark">Landmark</label>
                                                                    <input type="text" class="form-control" id="Editlandmark" name="landmark">
                                                                    <div class="error-message" id="Editlandmark-error"></div>
                                                                </div><!-- End .col-sm-6 -->
                                                            </div><!-- End .row -->
                                        
                                                            <div class="text-center mt-3">
                                                                <button type="submit" class="btn btn-outline-primary-2">
                                                                    <span>SAVE CHANGES</span>
                                                                    <i class="icon-long-arrow-right"></i>
                                                                </button>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
    
                                  <!-----Edit Address modal End------>
                                    
                                
                                    

								</div>
	                		</div><!-- End .col-lg-9 -->
	                	</div><!-- End .row -->
	                </div><!-- End .container -->
                </div><!-- End .dashboard -->
            </div><!-- End .page-content -->
        </main><!-- End .main -->




                             <!-------modal for change Password-------->

        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title text-center w-100" id="exampleModalLabel">Change Password</h5>
                        <button type="button" class="btn-close custom-close-btn" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="password-form">
                            <div class="form-group position-relative">
                                <input type="password" class="form-control" id="old-password" placeholder="Old Password" name="oldpassword" required>
                                <i class="far fa-eye-slash position-absolute toggle-password" data-toggle="#old-password" style="top: 50%; right: 10px; transform: translateY(-50%); cursor: pointer;"></i>
                                <div id="old-password-error" class="error-message"></div>
                            </div>
                            <div class="form-group position-relative">
                                <input type="password" class="form-control" id="new-password" placeholder="New Password" name="password" required>
                                <i class="far fa-eye-slash position-absolute toggle-password" data-toggle="#new-password" style="top: 50%; right: 10px; transform: translateY(-50%); cursor: pointer;"></i>
                                <div id="new-password-error" class="error-message"></div>
                            </div>
                            <div class="form-group position-relative">
                                <input type="password" class="form-control" id="confirm-password" placeholder="Confirm Password" name="confirmpassword" required>
                                <i class="far fa-eye-slash position-absolute toggle-password" data-toggle="#confirm-password" style="top: 50%; right: 10px; transform: translateY(-50%); cursor: pointer;"></i>
                                <div id="confirm-password-error" class="error-message"></div>
                            </div>
                            <button type="submit" class="btn btn-dark d-block mx-auto my-4">Change Password</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
                             
                             <!-------modal for  change Password end-------->

        

                             <footer class="footer">
                                <div class="footer-middle">
                                    <div class="container">
                                        <div class="row">
                                            <div class="col-sm-6 col-lg-3">
                                                <div class="widget widget-about">
                                                    <h4 class="widget-title">about VAANZA</h4><!-- End .widget-title -->
                                                    <p>Discover your unique style at VAANZA. We're more than just a clothing store; we're a community of fashion enthusiasts who believe that every outfit tells a story. Our curated collection features the latest trends and sustainable options to help you express yourself confidently. </p>
                    
                                                    <div class="social-icons">
                                                        <a href="#" class="social-icon" title="Facebook" target="_blank"><i class="icon-facebook-f"></i></a>
                                                        <a href="#" class="social-icon" title="Twitter" target="_blank"><i class="icon-twitter"></i></a>
                                                        <a href="#" class="social-icon" title="Instagram" target="_blank"><i class="icon-instagram"></i></a>
                                                        <a href="#" class="social-icon" title="Youtube" target="_blank"><i class="icon-youtube"></i></a>
                                                    </div><!-- End .soial-icons -->
                                                </div><!-- End .widget about-widget -->
                                            </div><!-- End .col-sm-6 col-lg-3 -->
                    
                                            <div class="col-sm-6 col-lg-3">
                                                <div class="widget">
                                                    <h4 class="widget-title">Useful Links</h4><!-- End .widget-title -->
                    
                                                    <ul class="widget-list">
                                                        <li><a href="about.html">About VAANZA</a></li>
                                                        <li><a href="#">How to shop on VAANZA</a></li>
                                                        <li><a href="#">FAQ</a></li>
                                                        <li><a href="contact.html">Contact us</a></li>
                                                        <li><a href="/login">Log in</a></li>
                                                    </ul><!-- End .widget-list -->
                                                </div><!-- End .widget -->
                                            </div><!-- End .col-sm-6 col-lg-3 -->
                    
                                            <div class="col-sm-6 col-lg-3">
                                                <div class="widget">
                                                    <h4 class="widget-title">Customer Service</h4><!-- End .widget-title -->
                    
                                                    <ul class="widget-list">
                                                        <li><a href="#">Payment Methods</a></li>
                                                        <li><a href="#">Money-back guarantee!</a></li>
                                                        <li><a href="#">Returns</a></li>
                                                        <li><a href="#">Shipping</a></li>
                                                        <li><a href="#">Terms and conditions</a></li>
                                                        <li><a href="#">Privacy Policy</a></li>
                                                    </ul><!-- End .widget-list -->
                                                </div><!-- End .widget -->
                                            </div><!-- End .col-sm-6 col-lg-3 -->
                    
                                            <div class="col-sm-6 col-lg-3">
                                                <div class="widget">
                                                    <h4 class="widget-title">My Account</h4><!-- End .widget-title -->
                    
                                                    <ul class="widget-list">
                                                        <li><a href="/login">Sign In</a></li>
                                                        <li><a href="/login">View Cart</a></li>
                                                        <li><a href="#">My Wishlist</a></li>
                                                        <li><a href="#">Track My Order</a></li>
                                                        <li><a href="#">Help</a></li>
                                                    </ul><!-- End .widget-list -->
                                                </div><!-- End .widget -->
                                            </div><!-- End .col-sm-6 col-lg-3 -->
                                        </div><!-- End .row -->
                                    </div><!-- End .container -->
                                </div><!-- End .footer-middle -->
                    
                                <div class="footer-bottom">
                                    <div class="container">
                                        <figure class="footer-payments">
                                            <img src="/assets/images/payments.png" alt="Payment methods" width="272" height="20">
                                        </figure><!-- End .footer-payments -->
                                        <!-- <img src="/assets/images/demos/demo-6/logo-footer.png" alt="VAANZA Logo" width="82" height="25"> -->
                                        <p class="footer-copyright">Copyright © 2024 VAANZA Store. All Rights Reserved.</p><!-- End .footer-copyright -->
                                    </div><!-- End .container -->
                                </div><!-- End .footer-bottom -->
                            </footer><!-- End .footer -->
    </div><!-- End .page-wrapper -->
    <button id="scroll-top" title="Back to Top"><i class="icon-arrow-up"></i></button>

    <!-- Mobile Menu -->
    <div class="mobile-menu-overlay"></div><!-- End .mobil-menu-overlay -->

    <div class="mobile-menu-container">
        <div class="mobile-menu-wrapper">
            <span class="mobile-menu-close"><i class="icon-close"></i></span>

            
            <nav class="mobile-nav">
                <ul class="mobile-menu">
                    <li class="active">
                        <a href="/">Home</a>
                    </li>
                    <li>
                        <a href="/shop/gender/Men">MEN</a>
                    </li>
                    <li>
                        <a href="/shop/gender/Women" class="sf-with-ul">Women</a>
                    </li>
                    <li>
                        <a href="/about">ABOUT US</a>
                    
                    </li>
                    <li>
                        <a href="/contact">CONTACT</a>
                    </li>
                 
                </ul>
            </nav><!-- End .mobile-nav -->

            <div class="social-icons">
                <a href="#" class="social-icon" target="_blank" title="Facebook"><i class="icon-facebook-f"></i></a>
                <a href="#" class="social-icon" target="_blank" title="Twitter"><i class="icon-twitter"></i></a>
                <a href="#" class="social-icon" target="_blank" title="Instagram"><i class="icon-instagram"></i></a>
                <a href="#" class="social-icon" target="_blank" title="Youtube"><i class="icon-youtube"></i></a>
            </div><!-- End .social-icons -->
        </div><!-- End .mobile-menu-wrapper -->
    </div><!-- End .mobile-menu-container -->

    



    <script>
        document.querySelectorAll('.btn-invoice').forEach(button => {
            button.addEventListener('click', async function() {
                const orderId = this.getAttribute('data-order-id');
    
                try {
                    const response = await fetch('/downloadInvoice', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ orderId })
                    });
    
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `Invoice_${orderId}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                    } else if (response.status === 404) {
                        const data = await response.json();
                        if (!data.isActive) {
                            window.location.href = '/userLogin';
                        } else {
                            console.error('Order not found or other error occurred');
                        }
                    } else {
                        console.error('Failed to generate invoice');
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            });
        });
    </script>

    <script>
   document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const tab = urlParams.get('tab');
        if (tab) {
            const tabLink = document.querySelector(`a[href="#tab-${tab}"]`);
            if (tabLink) {
                tabLink.click(); // Activate the tab
            }
        }
    });
    
    </script>
 
    
<script>
function toggleEdit() {
    const nameField = document.getElementById('profile-name');
    const phoneField = document.getElementById('profile-phone');

    const isReadOnly = nameField.readOnly;

    nameField.readOnly = !isReadOnly;
    phoneField.readOnly = !isReadOnly;

    document.getElementById('editButton').style.display = isReadOnly ? 'none' : 'block';
    document.getElementById('updateButton').style.display = isReadOnly ? 'block' : 'none';
}

function validate() {
    let isValid = true;

    const nameField = document.getElementById('profile-name');
    const phoneField = document.getElementById('profile-phone');

    const nameError = document.getElementById('name-error');
    const mobileError = document.getElementById('mobile-error');

    nameError.textContent = '';
    mobileError.textContent = '';

    if (nameField.value.trim() === '') {
        nameError.textContent = 'Name is required.';
        isValid = false;
    } else if (!/^[a-zA-Z\s]+$/.test(nameField.value)) {
        nameError.textContent = 'Name must contain only letters and spaces.';
        isValid = false;
    }

    if (phoneField.value.trim() === '') {
        mobileError.textContent = 'Mobile number is required.';
        isValid = false;
    } else if (!/^\d{10}$/.test(phoneField.value)) {
        mobileError.textContent = 'Mobile number is invalid.';
        isValid = false;
    }

    if (isValid) {
        submitForm();
    }

    return false;
}

async function submitForm() {
    const nameField = document.getElementById('profile-name');
    const phoneField = document.getElementById('profile-phone');

    const response = await fetch('/editProfile', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            updatedName: nameField.value,
            updatedMobile: phoneField.value,
        }),
    });

    const result = await response.json();

    if (result.edited) {
        Swal.fire({
            icon: 'success',
            title: 'Profile updated successfully!',
            showConfirmButton: false,
            timer: 1500
        }).then(() => {
            location.reload();
        });
    } else {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Something went wrong. Please try again later.',
        });
    }
}

</script>  
<script>   
document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('password-form').addEventListener('submit', function (event) {
        event.preventDefault();

        const oldPass = document.getElementById('old-password').value;
        const newPass = document.getElementById('new-password').value;
        const confirmPass = document.getElementById('confirm-password').value;

        const oldPasswordError = document.getElementById('old-password-error');
        const newPasswordError = document.getElementById('new-password-error');
        const confirmPasswordError = document.getElementById('confirm-password-error');

        // Reset error messages
        oldPasswordError.textContent = '';
        newPasswordError.textContent = '';
        confirmPasswordError.textContent = '';

        if (oldPass.length < 6) {
            document.getElementById('old-password').style.border = 'solid 1px red';
            oldPasswordError.textContent = "Password must be at least 6 characters long";
            setTimeout(function () {
                document.getElementById('old-password').style.border = '';
                oldPasswordError.textContent = '';
            }, 5000);
            return false;
        } else if (newPass.length < 6) {
            document.getElementById('new-password').style.border = 'solid 1px red';
            newPasswordError.textContent = "Password must be at least 6 characters long";
            setTimeout(function () {
                document.getElementById('new-password').style.border = '';
                newPasswordError.textContent = '';
            }, 5000);
            return false;
        } else if (newPass !== confirmPass) {
            document.getElementById('confirm-password').style.border = 'solid 1px red';
            confirmPasswordError.textContent = "Passwords should match";
            setTimeout(function () {
                document.getElementById('confirm-password').style.border = '';
                confirmPasswordError.textContent = '';
            }, 3000);
            return false;
        }

        const data = {
            oldPass: oldPass,
            confirmPass: confirmPass,
            useremail: '<%= locals.user.email %>'
        };

        fetch('/reset-pass', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json().then(result => ({ status: response.status, body: result })))
        .then(({ status, body }) => {
            if (status === 200 && body.reseted === true) {
                Swal.fire({
                    icon: 'success',
                    text: body.message
                }).then(() => {
                    location.reload();
                });
                document.getElementById('old-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
                $('#exampleModal').modal('hide');
            } else {
                Swal.fire({
                    icon: 'error',
                    text: body.message
                });
                if (body.res === false) {
                    document.getElementById('old-password').value = '';
                } else if (body.reseted === false) {
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                text: 'An error occurred. Please try again.'
            });
        });
    });
});
</script>

<script>
    document.querySelectorAll('.toggle-password').forEach(toggle => {
        toggle.addEventListener('click', function() {
            const input = document.querySelector(this.getAttribute('data-toggle'));
            if (input.type === 'password') {
                input.type = 'text';
                this.classList.remove('fa-eye-slash');
                this.classList.add('fa-eye');
            } else {
                input.type = 'password';
                this.classList.remove('fa-eye');
                this.classList.add('fa-eye-slash');
            }
        });
    });
    </script>

<script>
   document.getElementById('address-form').addEventListener('submit', function(event) {
    event.preventDefault();

    // Reset all error messages
    resetErrorMessages();

    // Fetch form data
    const name = document.getElementById('name').value.trim();
    const number = document.getElementById('number').value.trim();
    const address = document.getElementById('address').value.trim();
    const street = document.getElementById('street').value.trim();
    const postalCode = document.getElementById('postalCode').value.trim();
    const state = document.getElementById('state').value.trim();
    const landmark = document.getElementById('landmark').value.trim();

    // Validate each field
    let isValid = true;

    // Validate name
    if (!name) {
        isValid = false;
        displayErrorMessage('name', 'Name is required.');
    }

    // Validate number using regex
    if (!number) {
        isValid = false;
        displayErrorMessage('number', 'Mobile number is required.');
    } else if (!/^([6-9]\d{9})$/.test(number)) {
        isValid = false;
        displayErrorMessage('number', 'Please enter a valid 10-digit mobile number.');
    }

    // Validate address
    if (!address) {
        isValid = false;76
    }

    // Validate street
    if (!street) {
        isValid = false;
        displayErrorMessage('street', 'Street/City is required.');
    }

    // Validate postal code using regex
    if (!postalCode) {
        isValid = false;
        displayErrorMessage('postalCode', 'Pincode is required.');
    } else if (!/^\d{6}$/.test(postalCode)) {
        isValid = false;
        displayErrorMessage('postalCode', 'Please enter a valid 6-digit pincode.');
    }

    // Validate state
    if (!state) {
        isValid = false;
        displayErrorMessage('state', 'State is required.');
    }

    // If any field is invalid, prevent form submission
    if (!isValid) {
        return;
    }

    // If all fields are valid, proceed with form submission
    const addressData = {
        name,
        number,
        address,
        street,
        postalCode,
        state,
        landmark
    };

    fetch('/add-address', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(addressData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Address saved successfully!',
                showConfirmButton: false,
                timer: 1500
            });

            // Add the new address to the address list
            const addressContainer = document.getElementById('address-container');
            const newAddressHTML = `
                <div class="col-lg-12 address-card" data-address-id="${data.addressId}">
                    <div class="card card-dashboard">
                        <div class="card-body">
                            <h3 class="card-title"> Address</h3>
                            <p>
                                ${addressData.name}<br>
                                ${addressData.address}<br>
                                ${addressData.street}<br>
                                ${addressData.state}, ${addressData.postalCode}<br>
                                ${addressData.landmark}<br>
                                ${addressData.number}<br>
                                <a href="#" class="edit-address">Edit <i class="icon-edit"></i></a>
                            </p>
                        </div><!-- End .card-body -->
                    </div><!-- End .card-dashboard -->
                </div><!-- End .col-lg-6 -->
            `;
            addressContainer.insertAdjacentHTML('beforeend', newAddressHTML);

            // Attach the edit functionality to the new address
            const newEditLink = addressContainer.querySelector('.edit-address:last-of-type');
            newEditLink.addEventListener('click', function(event) {
                event.preventDefault();
                const addressCard = this.closest('.address-card');
                const addressData = extractAddressData(addressCard);
                populateEditModal(addressData);
                $('#editAddressModal').modal('show');
            });

            // Reset the form
            document.getElementById('address-form').reset();

            // Hide the modal
            $('#addAddressModal').modal('hide');
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Failed to save address.',
                text: data.message
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'An error occurred while saving the address.'
        });
    });
});

function displayErrorMessage(fieldId, message) {
    const errorElement = document.getElementById(`${fieldId}-error`);
    if (errorElement) {
        errorElement.textContent = message;
    }
}

function resetErrorMessages() {
    const errorMessages = document.querySelectorAll('.error-message');
    errorMessages.forEach(message => {
        message.textContent = '';
    });
}

function extractAddressData(addressCard) {
    const paragraphContent = addressCard.querySelector('p').innerText.split('\n');
    const addressId = addressCard.dataset.addressId;
    return {
        id: addressId,
        name: paragraphContent[0],
        address: paragraphContent[1],
        street: paragraphContent[2],
        stateAndPostal: paragraphContent[3],
        landmark: paragraphContent[4],
        number: paragraphContent[5]
    };
}

function populateEditModal(address) {
    document.getElementById('EditId').value = address.id || '';
    document.getElementById('Editname').value = address.name || '';
    document.getElementById('Editnumber').value = address.number || '';
    document.getElementById('Editaddress').value = address.address || '';
    document.getElementById('Editstreet').value = address.street || '';
    document.getElementById('EditpostalCode').value = address.stateAndPostal.split(', ')[1] || '';
    document.getElementById('Editstate').value = address.stateAndPostal.split(', ')[0] || '';
    document.getElementById('Editlandmark').value = address.landmark || '';
}


</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const editLinks = document.querySelectorAll('.edit-address');
    const editForm = document.querySelector('#editAddressModal form');

    editLinks.forEach(link => {
        link.addEventListener('click', function(event) {
            event.preventDefault();
            const addressCard = this.closest('.address-card');
            const addressData = extractAddressData(addressCard);
            populateEditModal(addressData);
            $('#editAddressModal').modal('show');
        });
    });

    function extractAddressData(addressCard) {
        const paragraphContent = addressCard.querySelector('p').innerText.split('\n');
        const addressId = addressCard.dataset.addressId;
        return {
            id: addressId,
            name: paragraphContent[0],
            address: paragraphContent[1],
            street: paragraphContent[2],
            stateAndPostal: paragraphContent[3],
            landmark: paragraphContent[4],
            number: paragraphContent[5]
        };
    }

    function populateEditModal(address) {
        document.getElementById('EditId').value = address.id || '';
        document.getElementById('Editname').value = address.name || '';
        document.getElementById('Editnumber').value = address.number || '';
        document.getElementById('Editaddress').value = address.address || '';
        document.getElementById('Editstreet').value = address.street || '';
        document.getElementById('EditpostalCode').value = address.stateAndPostal.split(', ')[1] || '';
        document.getElementById('Editstate').value = address.stateAndPostal.split(', ')[0] || '';
        document.getElementById('Editlandmark').value = address.landmark || '';
    }

    editForm.addEventListener('submit', async function(event) {
        event.preventDefault();

        const formData = {
            id: document.getElementById('EditId').value.trim(),
            name: document.getElementById('Editname').value.trim(),
            number: document.getElementById('Editnumber').value.trim(),
            address: document.getElementById('Editaddress').value.trim(),
            street: document.getElementById('Editstreet').value.trim(),
            postalCode: document.getElementById('EditpostalCode').value.trim(),
            state: document.getElementById('Editstate').value.trim(),
            landmark: document.getElementById('Editlandmark').value.trim()
        };

        let isValid = true;

        // Validate name
        if (!formData.name) {
            document.getElementById('Editname-error').innerHTML = 'Please enter your full name.';
            isValid = false;
        } else if (formData.name.includes('.')) {
            document.getElementById('Editname-error').innerHTML = 'Enter a valid name';
            isValid = false;
        } else {
            document.getElementById('Editname-error').innerHTML = '';
        }

        // Validate number
        if (!formData.number || formData.number.trim() === '') {
            document.getElementById('Editnumber-error').innerHTML = 'Please enter your mobile number.';
            isValid = false;
        } else if (!/^[0-9]+$/.test(formData.number) || formData.number.length !== 10) {
            document.getElementById('Editnumber-error').innerHTML = 'Please enter a valid 10-digit mobile number.';
            isValid = false;
        } else {
            document.getElementById('Editnumber-error').innerHTML = '';
        }

        // Validate address
        if (!formData.address || formData.address.trim() === '') {
            document.getElementById('Editaddress-error').innerHTML = 'Please enter your address.';
            isValid = false;
        }  else {
            document.getElementById('Editaddress-error').innerHTML = '';
        }

        // Validate street
        if (!formData.street || formData.street.trim() === '') {
            document.getElementById('Editstreet-error').innerHTML = 'Please enter your street/city.';
            isValid = false;
        } else if (formData.street.includes('.')) {
            document.getElementById('Editstreet-error').innerHTML = 'Enter a valid Street name';
            isValid = false;
        } else {
            document.getElementById('Editstreet-error').innerHTML = '';
        }

        // Validate postal code
        if (!formData.postalCode || formData.postalCode.trim() === '') {
            console.log("postalCode")
            document.getElementById('EditpostalCode-error').innerHTML = 'Please enter your pincode.';
            isValid = false;
        } else if (!/^[0-9]+$/.test(formData.postalCode) || formData.postalCode.length !== 6) {
            console.log("postalCode")
            document.getElementById('EditpostalCode-error').textContent = 'Please enter a valid 6-digit pincode.';
            isValid = false;
        } else {
            document.getElementById('EditpostalCode-error').innerHTML = '';
        }

        // Validate state
        if (!formData.state || formData.state.trim() === '') {
            document.getElementById('Editstate-error').innerHTML = 'Please enter your state.';
            isValid = false;
        } else if (formData.state.includes('.')) {
            document.getElementById('Editstate-error').innerHTML = 'State should not contain dots.';
            isValid = false;
        } else {
            document.getElementById('Editstate-error').innerHTML = '';
        }

        // Validate landmark (optional)
        if (formData.landmark && formData.landmark.trim() === '') {
            document.getElementById('Editlandmark-error').innerHTML = 'Please enter a valid landmark.';
            isValid = false;
        } else if (formData.landmark && formData.landmark.includes('.')) {
            document.getElementById('Editlandmark-error').innerHTML = 'Landmark should not contain dots.';
            isValid = false;
        } else {
            document.getElementById('Editlandmark-error').innerHTML = '';
        }

        if (isValid) {
            try {
                const response = await fetch('/edit-address', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Address updated successfully!',
                        showConfirmButton: false,
                        timer: 1500
                    });
                    $('#editAddressModal').modal('hide');
                    updateAddressDisplay(formData);
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Failed to update address.',
                        text: data.message
                    });
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An error occurred while updating the address.'
                });
            }
        }
    });

    function updateAddressDisplay(updatedAddress) {
        const addressCards = document.querySelectorAll('.address-card');
        addressCards.forEach(card => {
            if (card.dataset.addressId === updatedAddress.id) {
                const addressParagraph = card.querySelector('p');
                addressParagraph.innerHTML = `
                    ${updatedAddress.name}<br>
                    ${updatedAddress.address}<br>
                    ${updatedAddress.street}<br>
                    ${updatedAddress.state}, ${updatedAddress.postalCode}<br>
                    ${updatedAddress.landmark}<br>
                    ${updatedAddress.number}<br>
                    <a href="#" class="edit-address" data-toggle="modal" data-target="#editAddressModal" data-index="${card.dataset.addressId}">Edit <i class="icon-edit"></i></a>
                `;
            }
        });
    }
});
document.addEventListener('DOMContentLoaded', function() {
    const deleteButtons = document.querySelectorAll('.delete-address');

    deleteButtons.forEach(button => {
        button.addEventListener('click', async function(event) {
            event.preventDefault();

            const addressId = this.getAttribute('data-address-id');
            const addressCard = this.closest('.address-card'); // Assuming each address is wrapped in a '.address-card' container

            // Show confirmation dialog before deleting
            Swal.fire({
                title: 'Are you sure?',
                text: 'You will not be able to recover this address!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const response = await fetch(`/delete-address/${addressId}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        const data = await response.json();
                        if (data.success) {
                            // Remove the address card from the DOM
                            addressCard.remove();

                            // Show success message
                            Swal.fire({
                                icon: 'success',
                                title: 'Address deleted!',
                                text: 'Your address has been successfully deleted.',
                                showConfirmButton: false,
                                timer: 1500
                            });
                        } else {
                            // Handle failure
                            Swal.fire({
                                icon: 'error',
                                title: 'Failed to delete address',
                                text: data.message
                            });
                        }
                    } catch (error) {
                        console.error('Error deleting address:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'An error occurred while deleting the address.'
                        });
                    }
                }
            });
        });
    });
});

</script>

    
<script>
    function toggleOrderDetails(orderId) {
        const orderProducts = document.getElementById(`order-products-${orderId}`);
        if (orderProducts.style.display === 'none') {
            orderProducts.style.display = 'block';
        } else {
            orderProducts.style.display = 'none';
        }
    }



    function openCancelModal(orderId, productId, variantId) {
  // Set the orderId, productId, and variantId in the hidden inputs
  console.log(`productId ${variantId}`)
  document.getElementById('cancelOrderId').value = orderId;
  document.getElementById('cancelProductId').value = productId;
  document.getElementById('cancelVariantId').value = variantId;

  // Open the modal
  const cancelModal = new bootstrap.Modal(document.getElementById('cancelModal'));
  cancelModal.show();
}

document.getElementById('confirmCancelButton').addEventListener('click', async function () {
  const orderId = document.getElementById('cancelOrderId').value;
  const productId = document.getElementById('cancelProductId').value;
  const variantId = document.getElementById('cancelVariantId').value;
  const cancelReason = document.getElementById('cancelReason').value;

  try {
    const response = await fetch('/cancel-order', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ orderId, productId, variantId, cancelReason })
    });

    if (response.ok) {
      Swal.fire({
        icon: 'success',
        title: 'Product Cancelled',
        text: 'The product has been cancelled successfully.',
        showConfirmButton: false,
        timer: 2000
      }).then(() => {
        location.reload();
      });
    } else {
      const data = await response.json();
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: data.message || 'Failed to cancel the product.',
      });
    }
  } catch (error) {
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'An error occurred while cancelling the product.',
    });
  }
});




function openReturnModal(orderId, productId, variantId) {
  // Set the orderId, productId, and variantId in the hidden inputs
  document.getElementById('returnOrderId').value = orderId;
  document.getElementById('returnProductId').value = productId;
  document.getElementById('returnVariantId').value = variantId;

  // Open the modal
  const returnModal = new bootstrap.Modal(document.getElementById('returnModal'));
  returnModal.show();
}

document.getElementById('confirmReturnButton').addEventListener('click', async function () {
  const orderId = document.getElementById('returnOrderId').value;
  const productId = document.getElementById('returnProductId').value;
  const variantId = document.getElementById('returnVariantId').value;
  const returnReason = document.getElementById('returnReason').value;
console.log("productId",productId)
  try {
    const response = await fetch('/return-order', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ orderId, productId, variantId, returnReason })
    });

    if (response.ok) {
      Swal.fire({
        icon: 'success',
        title: 'Product Returned',
        text: 'The product has been returned successfully.',
        showConfirmButton: false,
        timer: 2000
      }).then(() => {
        location.reload();
      });
    } else {
      const data = await response.json();
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: data.message || 'Failed to return the product.',
      });
    }
  } catch (error) {
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'An error occurred while returning the product.',
    });
  }
});

</script>

<script>
    function retryPayment(orderId, amount) {
    fetch('/retry-payment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ orderId: orderId, amount: amount }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Initialize Razorpay payment
            const options = {
                key: data.keyId,
                amount: data.amount,
                currency: data.currency,
                name: 'VAANZA',
                description: 'Order Payment',
                order_id: data.razorpayOrderId,
                handler: function (response) {
                    updatePaymentStatus(orderId, 'Paid', response);
                },
                prefill: {
                    name: 'Customer Name',
                    email: 'customer@example.com',
                    contact: 'Customer Phone Number'
                },
                theme: {
                    color: '#F37254'
                },
                modal: {
                    ondismiss: function() {
                        updatePaymentStatus(orderId, 'Failed');
                    }
                }
            };
            const rzp = new Razorpay(options);
            rzp.open();
        } else {
            Swal.fire({
                title: 'Error!',
                text: data.message || 'Failed to retry payment. Please try again.',
                icon: 'error',
                confirmButtonText: 'OK'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            title: 'Error!',
            text: 'An unexpected error occurred. Please try again later.',
            icon: 'error',
            confirmButtonText: 'OK'
        });
    });
}


function updatePaymentStatus(orderId, status, razorpayResponse = null) {
    const updateData = {
        orderId: orderId,
        status: status
    };

    if (razorpayResponse) {
        updateData.razorpay_payment_id = razorpayResponse.razorpay_payment_id;
        updateData.razorpay_order_id = razorpayResponse.razorpay_order_id;
        updateData.razorpay_signature = razorpayResponse.razorpay_signature;
    }

    fetch('/update-payment-status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(updateData)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            if (status === 'Paid') {
                window.location.href = `/order-summary/${orderId}`;
            } else {
                // Payment failed or was dismissed
                window.location.href = '/profile';
            }
        } else {
            Swal.fire({
                title: 'Error',
                text: 'Failed to update payment status. Please contact support.',
                icon: 'error',
                confirmButtonText: 'OK'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            title: 'Error',
            text: 'An error occurred while updating payment status.',
            icon: 'error',
            confirmButtonText: 'OK'
        });
    });
}
</script>
<script>
    document.getElementById('showRecentTransactions').addEventListener('click', function() {
    var recentTransactions = document.getElementById('recentTransactions');
    if (recentTransactions.style.display === 'none') {
        recentTransactions.style.display = 'block';
        this.textContent = 'Hide Recent Transactions';
    } else {
        recentTransactions.style.display = 'none';
        this.textContent = 'Show Recent Transactions';
    }
});


function copyReferralCode() {
    var copyText = document.getElementById("referral-code");
    copyText.select();
    copyText.setSelectionRange(0, 99999); // For mobile devices
    document.execCommand("copy");
    
    // Change button text temporarily
    var copyButton = document.querySelector('.input-group-append .btn');
    var originalText = copyButton.innerHTML;
    copyButton.innerHTML = '<i class="icon-check"></i> Copied!';
    
    // Revert button text after 2 seconds
    setTimeout(function() {
        copyButton.innerHTML = originalText;
    }, 2000);
}

</script>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</body>












<%- include('../layout/footer.ejs') -%>